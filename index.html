<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>æ”¯æ´è¨˜éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæœ€çµ‚ç‰ˆï¼‰</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'ãƒ¡ã‚¤ãƒªã‚ª', 'Meiryo', sans-serif;
      padding: 10px; 
      background: #f5f5f5;
      margin: 0;
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }
    
    h1 { 
      color: #2c5aa0; 
      text-align: center; 
      margin: 10px 0 20px 0;
      font-size: 1.5em;
    }
    
    .controls { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
      margin-bottom: 15px;
      justify-content: center;
    }
    
    .btn { 
      padding: 12px 20px; 
      cursor: pointer; 
      border: none; 
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.2s;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
      min-height: 48px;
    }
    .btn:active { 
      transform: scale(0.95); 
      opacity: 0.8;
    }
    .btn-add { background: #4CAF50; color: white; }
    .btn-save { background: #FF9800; color: white; }
    .btn-export { background: #2196F3; color: white; }
    .btn-clear { background: #f44336; color: white; }
    .btn-cancel { background: #9E9E9E; color: white; }
    .btn-master { background: #9C27B0; color: white; }
    .btn-sync { background: #00BCD4; color: white; }
    .btn-remove { background: #f44336; color: white; font-size: 14px; padding: 8px 16px; min-height: 40px; }
    .btn-voice { 
      background: #FF5722; 
      color: white;
      position: relative;
      min-width: 48px;
      min-height: 48px;
      padding: 10px;
      border-radius: 6px;
    }
    .btn-voice.recording {
      background: #f44336;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 20px auto;
      padding: 20px;
      border-radius: 12px;
      width: 95%;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #2c5aa0;
    }
    
    .modal-header h2 {
      color: #2c5aa0;
      margin: 0;
      font-size: 1.3em;
    }
    
    .close {
      color: #aaa;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
      padding: 0 10px;
      min-width: 48px;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
    }
    
    .close:hover, .close:active {
      color: #000;
    }
    
    .master-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    
    .master-section h3 {
      color: #2c5aa0;
      margin-top: 0;
      font-size: 1.1em;
    }
    
    .master-input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .master-input-group input,
    .master-input-group select {
      padding: 14px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      min-height: 48px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .master-input-group input:focus,
    .master-input-group select:focus {
      outline: none;
      border-color: #2c5aa0;
    }
    
    .master-input-group button {
      min-height: 48px;
    }
    
    .master-list {
      margin-top: 15px;
    }
    
    .master-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .master-item-info {
      flex: 1;
      min-width: 0;
    }
    
    .master-item-name {
      font-weight: bold;
      color: #333;
      word-break: break-word;
      font-size: 16px;
    }
    
    .master-item-service {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    
    .btn-delete {
      padding: 10px 16px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      min-width: 70px;
      min-height: 44px;
      margin-left: 10px;
      flex-shrink: 0;
      font-weight: bold;
      touch-action: manipulation;
    }
    
    .btn-delete:active {
      background: #d32f2f;
      transform: scale(0.95);
    }
    
    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-section {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .input-section h3 { 
      margin: 0 0 15px 0; 
      color: #2c5aa0; 
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 1.2em;
    }
    
    .input-row {
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      position: relative;
      margin-bottom: 15px;
    }
    
    .input-row.active {
      border: 2px solid #4CAF50;
      background: #f1f8f4;
    }
    
    /* 1æ®µç›®ï¼šåŸºæœ¬æƒ…å ± */
    .basic-info-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #ddd;
    }
    
    /* 2æ®µç›®ï¼šæ”¯æ´å†…å®¹ã‚¨ãƒªã‚¢ */
    .support-content-section {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .support-content-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 15px;
      padding: 14px;
      background: #fafafa;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      position: relative;
    }
    
    .support-content-row:last-child {
      margin-bottom: 0;
    }
    
    .support-label {
      font-weight: bold;
      color: #2c5aa0;
      margin-bottom: 10px;
      font-size: 1.1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .support-number {
      background: #2c5aa0;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.9em;
      display: inline-block;
    }
    
    .support-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 10px;
    }
    
    .input-field {
      display: flex;
      flex-direction: column;
    }
    
    .input-field label {
      font-size: 15px;
      font-weight: bold;
      color: #555;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .input-field label .required {
      color: red;
      font-size: 16px;
    }
    
    .input-field input,
    .input-field select,
    .input-field textarea {
      padding: 14px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: -apple-system, BlinkMacSystemFont, 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
      width: 100%;
      min-height: 48px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .input-field input:focus,
    .input-field select:focus,
    .input-field textarea:focus {
      outline: none;
      border-color: #2c5aa0;
    }
    
    .input-field select {
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8"><path fill="%23333" d="M0 0l6 8 6-8z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }
    
    .input-field textarea {
      resize: vertical;
      min-height: 100px;
      line-height: 1.5;
    }
    
    .input-field-time {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
    }
    
    .input-field-time span {
      text-align: center;
      font-weight: bold;
    }
    
    .row-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .row-actions button {
      padding: 14px 24px;
      font-size: 16px;
      min-height: 48px;
      flex: 1;
      min-width: 120px;
    }
    
    /* ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .sync-section {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .sync-section h3 {
      color: #2c5aa0;
      margin-top: 0;
      font-size: 1.1em;
    }
    
    .sync-info {
      padding: 12px;
      background: #e3f2fd;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .sync-status {
      padding: 10px;
      background: #fff;
      border-left: 4px solid #4CAF50;
      margin-top: 10px;
      font-size: 14px;
      border-radius: 4px;
    }
    
    .sync-status.error {
      border-left-color: #f44336;
      background: #ffebee;
    }
    
    /* ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒªã‚¢ */
    .filter-box { 
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .filter-box h3 { 
      margin-top: 0; 
      color: #2c5aa0;
      font-size: 1.1em;
    }
    .filter-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .filter-row input, .filter-row select { 
      padding: 14px; 
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      min-height: 48px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .filter-row select {
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8"><path fill="%23333" d="M0 0l6 8 6-8z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    .table-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: white;
      min-width: 600px;
    }
    th, td { 
      border: 1px solid #e0e0e0; 
      padding: 12px 10px; 
      text-align: left;
      font-size: 14px;
    }
    th { 
      background: #2c5aa0; 
      color: white; 
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tr:nth-child(even) { background: #f9f9f9; }
    tr:hover { background: #e3f2fd; }
    
    .service-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      color: white;
      white-space: nowrap;
    }
    .badge-ç”Ÿæ´»ä»‹è­· { background: #4CAF50; }
    .badge-å°±åŠ´ç¶™ç¶šAå‹ { background: #2196F3; }
    .badge-å°±åŠ´ç¶™ç¶šBå‹ { background: #FF9800; }
    .badge-å…¥æ‰€æ”¯æ´ { background: #9C27B0; }
    .badge-å±…å®…ä»‹è­· { background: #00BCD4; }
    .badge-ãã®ä»– { background: #607D8B; }
    
    /* éŸ³å£°å…¥åŠ›ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .voice-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 40px;
      border-radius: 20px;
      z-index: 2000;
      display: none;
      text-align: center;
      min-width: 280px;
    }
    
    .voice-indicator.active {
      display: block;
    }
    
    .voice-wave {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      border: 4px solid #f44336;
      border-radius: 50%;
      animation: wave 1.5s infinite;
    }
    
    @keyframes wave {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.5; }
    }

    /* PCç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    @media screen and (min-width: 768px) {
      body { padding: 20px; font-size: 14px; }
      h1 { font-size: 2em; }
      
      .basic-info-row {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .support-content-row {
        display: grid;
        grid-template-columns: 2fr 2fr 1.5fr 3fr 2fr;
        gap: 10px;
      }
      
      .support-actions {
        grid-column: 1 / -1;
      }
      
      .master-input-group {
        flex-direction: row;
      }
      
      .filter-row {
        flex-direction: row;
        flex-wrap: wrap;
      }
      
      .filter-row input, 
      .filter-row select {
        flex: 1;
        min-width: 150px;
      }
      
      .row-actions button {
        flex: 0;
        min-width: 140px;
      }
      
      .btn {
        font-size: 14px;
        padding: 10px 20px;
        min-height: 44px;
      }
      
      .input-field input,
      .input-field select,
      .input-field textarea {
        font-size: 14px;
      }
    }
    
    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ */
    @media screen and (min-width: 600px) and (max-width: 767px) {
      .basic-info-row {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .support-content-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      
      .support-actions {
        grid-column: 1 / -1;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ“‹ æ”¯æ´è¨˜éŒ²ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

  <div class="controls">
    <button class="btn btn-master" onclick="openMasterModal()">âš™ï¸ ãƒã‚¹ã‚¿ãƒ¼</button>
    <button class="btn btn-sync" onclick="openSyncModal()">â˜ï¸ åŒæœŸ</button>
    <button class="btn btn-export" onclick="exportExcel()">ğŸ“¤ Excel</button>
    <button class="btn btn-clear" onclick="clearAll()">ğŸ—‘ï¸ å‰Šé™¤</button>
  </div>

  <!-- ãƒ‡ãƒ¼ã‚¿åŒæœŸè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="syncModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>â˜ï¸ ãƒ‡ãƒ¼ã‚¿åŒæœŸè¨­å®š</h2>
        <span class="close" onclick="closeSyncModal()">&times;</span>
      </div>
      
      <div class="sync-section">
        <h3>ğŸ“± è¤‡æ•°ç«¯æœ«ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰</h3>
        <div class="sync-info">
          <strong>ã€å…±æœ‰æ–¹æ³•ã€‘</strong><br>
          1. Google Sheetsã§æ–°è¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ<br>
          2. ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€ŒApps Scriptã€ã‚’é–‹ã<br>
          3. æä¾›ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ<br>
          4. ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’å–å¾—<br>
          5. ä¸‹è¨˜ã«URLã‚’å…¥åŠ›ã—ã¦ä¿å­˜
        </div>
        
        <div class="master-input-group">
          <input type="text" id="sheetsApiUrl" placeholder="Google Apps Script ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL">
          <button class="btn btn-save" onclick="saveSyncSettings()">ğŸ’¾ ä¿å­˜</button>
        </div>
        
        <div class="master-input-group" style="margin-top: 20px;">
          <button class="btn btn-sync" onclick="syncToCloud()">â¬†ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
          <button class="btn btn-add" onclick="syncFromCloud()">â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
        
        <div id="syncStatus" class="sync-status" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="masterModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âš™ï¸ ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†</h2>
        <span class="close" onclick="closeMasterModal()">&times;</span>
      </div>
      
      <!-- åˆ©ç”¨è€…ç™»éŒ² -->
      <div class="master-section">
        <h3>ğŸ‘¤ åˆ©ç”¨è€…ç™»éŒ²</h3>
        <div class="master-input-group">
          <input type="text" id="newUserName" placeholder="åˆ©ç”¨è€…åã‚’å…¥åŠ›">
          <select id="newUserService">
            <option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã‚’é¸æŠ</option>
          </select>
          <button class="btn btn-add" onclick="addUser()">è¿½åŠ </button>
        </div>
        <div id="userList" class="master-list"></div>
      </div>
      
      <!-- ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ç™»éŒ² -->
      <div class="master-section">
        <h3>ğŸ“‚ ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ç™»éŒ²</h3>
        <div class="master-input-group">
          <input type="text" id="newServiceName" placeholder="ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†åã‚’å…¥åŠ›">
          <button class="btn btn-add" onclick="addService()">è¿½åŠ </button>
        </div>
        <div id="serviceList" class="master-list"></div>
      </div>
      
      <!-- è¨˜éŒ²è€…ç™»éŒ² -->
      <div class="master-section">
        <h3>âœï¸ è¨˜éŒ²è€…ç™»éŒ²</h3>
        <div class="master-input-group">
          <input type="text" id="newStaffName" placeholder="è¨˜éŒ²è€…åã‚’å…¥åŠ›">
          <button class="btn btn-add" onclick="addStaff()">è¿½åŠ </button>
        </div>
        <div id="staffList" class="master-list"></div>
      </div>
      
      <!-- æ”¯æ´å†…å®¹ç™»éŒ² -->
      <div class="master-section">
        <h3>ğŸ“ æ”¯æ´å†…å®¹ç™»éŒ²</h3>
        <div class="master-input-group">
          <input type="text" id="newSupportType" placeholder="æ”¯æ´å†…å®¹ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šãƒ¬ã‚¯ãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰">
          <button class="btn btn-add" onclick="addSupportType()">è¿½åŠ </button>
        </div>
        <div id="supportTypeList" class="master-list"></div>
      </div>
      
      <!-- æ§˜å­ãƒ»çŠ¶æ…‹ç™»éŒ² -->
      <div class="master-section">
        <h3>ğŸ˜Š æ§˜å­ãƒ»çŠ¶æ…‹ç™»éŒ²</h3>
        <div class="master-input-group">
          <input type="text" id="newCondition" placeholder="æ§˜å­ãƒ»çŠ¶æ…‹ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šå…ƒæ°—ï¼‰">
          <button class="btn btn-add" onclick="addCondition()">è¿½åŠ </button>
        </div>
        <div id="conditionList" class="master-list"></div>
      </div>
    </div>
  </div>

  <!-- éŸ³å£°å…¥åŠ›ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
  <div id="voiceIndicator" class="voice-indicator">
    <div class="voice-wave"></div>
    <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">ğŸ¤ éŸ³å£°å…¥åŠ›ä¸­...</div>
    <div style="font-size: 16px;">è©±ã—ã¦ãã ã•ã„</div>
    <button class="btn btn-cancel" onclick="stopVoiceInput()" style="margin-top: 20px;">åœæ­¢</button>
  </div>

  <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="input-section">
    <h3>
      <span>âœï¸ è¨˜éŒ²å…¥åŠ›</span>
      <button class="btn btn-add" onclick="addInputRow()">â• è¨˜éŒ²è¿½åŠ </button>
    </h3>
    <div id="inputContainer">
      <!-- å…¥åŠ›è¡ŒãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
    </div>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒªã‚¢ -->
  <div class="filter-box">
    <h3>ğŸ” çµã‚Šè¾¼ã¿æ¤œç´¢</h3>
    <div class="filter-row">
      <input type="month" id="filterMonth" placeholder="æœˆã§çµã‚Šè¾¼ã¿">
      <select id="filterService">
        <option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ï¼ˆå…¨ã¦ï¼‰</option>
      </select>
      <input type="text" id="filterUser" placeholder="åˆ©ç”¨è€…åã§çµã‚Šè¾¼ã¿">
      <button class="btn btn-add" onclick="applyFilter()">ğŸ” æ¤œç´¢</button>
      <button class="btn btn-cancel" onclick="resetFilter()">â™» ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="table-container">
    <h3 style="color: #2c5aa0; margin-top: 0;">ğŸ“Š è¨˜éŒ²ä¸€è¦§</h3>
    <table id="recordTable">
      <thead>
        <tr>
          <th>è¨˜éŒ²æ—¥</th>
          <th>ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†</th>
          <th>åˆ©ç”¨è€…å</th>
          <th>è¨˜éŒ²è€…å</th>
          <th>æ”¯æ´å†…å®¹</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  let records = [];
  let filtered = [];
  let rowIdCounter = 0;
  let supportCounterMap = {}; // å„å…¥åŠ›è¡Œã®æ”¯æ´å†…å®¹ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
  
  // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
  let masterUsers = [];
  let masterServices = ["ç”Ÿæ´»ä»‹è­·", "å°±åŠ´ç¶™ç¶šAå‹", "å°±åŠ´ç¶™ç¶šBå‹", "å…¥æ‰€æ”¯æ´", "å±…å®…ä»‹è­·", "ãã®ä»–"];
  let masterStaff = [];
  let masterSupportTypes = ["é£Ÿäº‹æ”¯æ´", "æ’æ³„æ”¯æ´", "å…¥æµ´æ”¯æ´", "æ´»å‹•æ”¯æ´", "ç§»å‹•æ”¯æ´", "ä½œæ¥­æ”¯æ´", "å¥åº·ç®¡ç†", "ç›¸è«‡æ”¯æ´", "ãã®ä»–"];
  let masterConditions = ["è‰¯å¥½", "æ™®é€š", "ã‚„ã‚„ä¸èª¿", "ä¸èª¿", "è¦è¦³å¯Ÿ"];
  
  // éŸ³å£°èªè­˜
  let recognition = null;
  let currentVoiceInput = null;
  
  // éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
  function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.continuous = false;
      recognition.interimResults = false;
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        if (currentVoiceInput) {
          currentVoiceInput.value = transcript;
        }
        hideVoiceIndicator();
      };
      
      recognition.onerror = function(event) {
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
        hideVoiceIndicator();
        if (event.error !== 'no-speech' && event.error !== 'aborted') {
          alert('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ' + event.error + '\n\nChromeã¾ãŸã¯Safariãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚');
        }
      };
      
      recognition.onend = function() {
        hideVoiceIndicator();
      };
    }
  }
  
  // éŸ³å£°å…¥åŠ›é–‹å§‹
  function startVoiceInput(inputElement) {
    if (!recognition) {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\n\nChromeã€Safariã€Edgeã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
      return;
    }
    
    currentVoiceInput = inputElement;
    showVoiceIndicator();
    
    try {
      recognition.start();
    } catch (e) {
      console.error('éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼:', e);
      hideVoiceIndicator();
      setTimeout(() => {
        try {
          recognition.start();
        } catch (e2) {
          console.error('éŸ³å£°èªè­˜å†é–‹ã‚¨ãƒ©ãƒ¼:', e2);
        }
      }, 100);
    }
  }
  
  function stopVoiceInput() {
    if (recognition) {
      recognition.stop();
    }
    hideVoiceIndicator();
  }
  
  function showVoiceIndicator() {
    document.getElementById('voiceIndicator').classList.add('active');
  }
  
  function hideVoiceIndicator() {
    document.getElementById('voiceIndicator').classList.remove('active');
  }
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
  function loadMasterData() {
    const savedUsers = localStorage.getItem('masterUsers');
    const savedServices = localStorage.getItem('masterServices');
    const savedStaff = localStorage.getItem('masterStaff');
    const savedSupportTypes = localStorage.getItem('masterSupportTypes');
    const savedConditions = localStorage.getItem('masterConditions');
    const savedRecords = localStorage.getItem('records');
    
    if (savedUsers) masterUsers = JSON.parse(savedUsers);
    if (savedServices) masterServices = JSON.parse(savedServices);
    if (savedStaff) masterStaff = JSON.parse(savedStaff);
    if (savedSupportTypes) masterSupportTypes = JSON.parse(savedSupportTypes);
    if (savedConditions) masterConditions = JSON.parse(savedConditions);
    if (savedRecords) {
      records = JSON.parse(savedRecords);
      filtered = [...records];
    }
  }
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
  function saveMasterData() {
    localStorage.setItem('masterUsers', JSON.stringify(masterUsers));
    localStorage.setItem('masterServices', JSON.stringify(masterServices));
    localStorage.setItem('masterStaff', JSON.stringify(masterStaff));
    localStorage.setItem('masterSupportTypes', JSON.stringify(masterSupportTypes));
    localStorage.setItem('masterConditions', JSON.stringify(masterConditions));
  }
  
  function saveRecords() {
    localStorage.setItem('records', JSON.stringify(records));
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
  function openMasterModal() {
    document.getElementById('masterModal').style.display = 'block';
    renderMasterLists();
  }
  
  function closeMasterModal() {
    document.getElementById('masterModal').style.display = 'none';
    updateFilterOptions();
  }
  
  function openSyncModal() {
    document.getElementById('syncModal').style.display = 'block';
    const savedUrl = localStorage.getItem('sheetsApiUrl');
    if (savedUrl) {
      document.getElementById('sheetsApiUrl').value = savedUrl;
    }
  }
  
  function closeSyncModal() {
    document.getElementById('syncModal').style.display = 'none';
  }
  
  // åŒæœŸè¨­å®šä¿å­˜
  function saveSyncSettings() {
    const url = document.getElementById('sheetsApiUrl').value.trim();
    if (url) {
      localStorage.setItem('sheetsApiUrl', url);
      showSyncStatus('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', false);
    } else {
      alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
  }
  
  // ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  async function syncToCloud() {
    const apiUrl = localStorage.getItem('sheetsApiUrl');
    if (!apiUrl) {
      alert('å…ˆã«Google Sheets APIã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„');
      return;
    }
    
    showSyncStatus('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', false);
    
    try {
      const data = {
        records: records,
        masterUsers: masterUsers,
        masterServices: masterServices,
        masterStaff: masterStaff,
        masterSupportTypes: masterSupportTypes,
        masterConditions: masterConditions
      };
      
      const response = await fetch(apiUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });
      
      showSyncStatus('âœ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ã¾ã—ãŸ', false);
    } catch (error) {
      showSyncStatus('âœ— ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
    }
  }
  
  // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  async function syncFromCloud() {
    const apiUrl = localStorage.getItem('sheetsApiUrl');
    if (!apiUrl) {
      alert('å…ˆã«Google Sheets APIã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„');
      return;
    }
    
    showSyncStatus('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...', false);
    
    try {
      const response = await fetch(apiUrl + '?action=get');
      const data = await response.json();
      
      if (data.records) records = data.records;
      if (data.masterUsers) masterUsers = data.masterUsers;
      if (data.masterServices) masterServices = data.masterServices;
      if (data.masterStaff) masterStaff = data.masterStaff;
      if (data.masterSupportTypes) masterSupportTypes = data.masterSupportTypes;
      if (data.masterConditions) masterConditions = data.masterConditions;
      
      saveMasterData();
      saveRecords();
      filtered = [...records];
      renderTable();
      updateFilterOptions();
      
      showSyncStatus('âœ“ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ã¾ã—ãŸ', false);
    } catch (error) {
      showSyncStatus('âœ— ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
    }
  }
  
  function showSyncStatus(message, isError) {
    const statusEl = document.getElementById('syncStatus');
    statusEl.textContent = message;
    statusEl.style.display = 'block';
    if (isError) {
      statusEl.classList.add('error');
    } else {
      statusEl.classList.remove('error');
    }
    
    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 5000);
  }
  
  // åˆ©ç”¨è€…è¿½åŠ 
  function addUser() {
    const name = document.getElementById('newUserName').value.trim();
    const service = document.getElementById('newUserService').value;
    
    if (!name) {
      alert('åˆ©ç”¨è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    if (!service) {
      alert('ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterUsers.some(u => u.name === name && u.service === service)) {
      alert('ã“ã®åˆ©ç”¨è€…ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterUsers.push({name, service});
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newUserName').value = '';
    document.getElementById('newUserService').value = '';
  }
  
  function deleteUser(index) {
    if (confirm(`ã€Œ${masterUsers[index].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterUsers.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function addService() {
    const name = document.getElementById('newServiceName').value.trim();
    
    if (!name) {
      alert('ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterServices.includes(name)) {
      alert('ã“ã®ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterServices.push(name);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newServiceName').value = '';
  }
  
  function deleteService(index) {
    if (confirm(`ã€Œ${masterServices[index]}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterServices.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function addStaff() {
    const name = document.getElementById('newStaffName').value.trim();
    
    if (!name) {
      alert('è¨˜éŒ²è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterStaff.includes(name)) {
      alert('ã“ã®è¨˜éŒ²è€…ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterStaff.push(name);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newStaffName').value = '';
  }
  
  function deleteStaff(index) {
    if (confirm(`ã€Œ${masterStaff[index]}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterStaff.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  // æ”¯æ´å†…å®¹è¿½åŠ 
  function addSupportType() {
    const name = document.getElementById('newSupportType').value.trim();
    
    if (!name) {
      alert('æ”¯æ´å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterSupportTypes.includes(name)) {
      alert('ã“ã®æ”¯æ´å†…å®¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterSupportTypes.push(name);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newSupportType').value = '';
  }
  
  function deleteSupportType(index) {
    if (confirm(`ã€Œ${masterSupportTypes[index]}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterSupportTypes.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  // æ§˜å­ãƒ»çŠ¶æ…‹è¿½åŠ 
  function addCondition() {
    const name = document.getElementById('newCondition').value.trim();
    
    if (!name) {
      alert('æ§˜å­ãƒ»çŠ¶æ…‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (masterConditions.includes(name)) {
      alert('ã“ã®æ§˜å­ãƒ»çŠ¶æ…‹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    masterConditions.push(name);
    saveMasterData();
    renderMasterLists();
    
    document.getElementById('newCondition').value = '';
  }
  
  function deleteCondition(index) {
    if (confirm(`ã€Œ${masterConditions[index]}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      masterConditions.splice(index, 1);
      saveMasterData();
      renderMasterLists();
    }
  }
  
  function renderMasterLists() {
    // ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†é¸æŠè‚¢ã‚’æ›´æ–°
    const newUserServiceEl = document.getElementById('newUserService');
    newUserServiceEl.innerHTML = '<option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã‚’é¸æŠ</option>';
    masterServices.forEach(service => {
      const option = document.createElement('option');
      option.value = service;
      option.textContent = service;
      newUserServiceEl.appendChild(option);
    });
    
    // åˆ©ç”¨è€…ãƒªã‚¹ãƒˆ
    const userListEl = document.getElementById('userList');
    userListEl.innerHTML = '';
    masterUsers.forEach((user, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${user.name}</div>
          <div class="master-item-service">
            <span class="service-badge badge-${user.service}">${user.service}</span>
          </div>
        </div>
        <button class="btn-delete" onclick="deleteUser(${index})">å‰Šé™¤</button>
      `;
      userListEl.appendChild(item);
    });
    
    // ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ãƒªã‚¹ãƒˆ
    const serviceListEl = document.getElementById('serviceList');
    serviceListEl.innerHTML = '';
    masterServices.forEach((service, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">
            <span class="service-badge badge-${service}">${service}</span>
          </div>
        </div>
        <button class="btn-delete" onclick="deleteService(${index})">å‰Šé™¤</button>
      `;
      serviceListEl.appendChild(item);
    });
    
    // è¨˜éŒ²è€…ãƒªã‚¹ãƒˆ
    const staffListEl = document.getElementById('staffList');
    staffListEl.innerHTML = '';
    masterStaff.forEach((staff, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${staff}</div>
        </div>
        <button class="btn-delete" onclick="deleteStaff(${index})">å‰Šé™¤</button>
      `;
      staffListEl.appendChild(item);
    });
    
    // æ”¯æ´å†…å®¹ãƒªã‚¹ãƒˆ
    const supportTypeListEl = document.getElementById('supportTypeList');
    supportTypeListEl.innerHTML = '';
    masterSupportTypes.forEach((type, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${type}</div>
        </div>
        <button class="btn-delete" onclick="deleteSupportType(${index})">å‰Šé™¤</button>
      `;
      supportTypeListEl.appendChild(item);
    });
    
    // æ§˜å­ãƒ»çŠ¶æ…‹ãƒªã‚¹ãƒˆ
    const conditionListEl = document.getElementById('conditionList');
    conditionListEl.innerHTML = '';
    masterConditions.forEach((condition, index) => {
      const item = document.createElement('div');
      item.className = 'master-item';
      item.innerHTML = `
        <div class="master-item-info">
          <div class="master-item-name">${condition}</div>
        </div>
        <button class="btn-delete" onclick="deleteCondition(${index})">å‰Šé™¤</button>
      `;
      conditionListEl.appendChild(item);
    });
  }
  
  function updateUserOptions(selectElement, serviceValue) {
    const row = selectElement.closest('.basic-info-row');
    if (!row) return;
    
    const userSelect = row.querySelector('.row-user');
    if (!userSelect) return;
    
    userSelect.innerHTML = '<option value="">åˆ©ç”¨è€…ã‚’é¸æŠ</option>';
    
    if (serviceValue) {
      const filteredUsers = masterUsers.filter(u => u.service === serviceValue);
      filteredUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user.name;
        option.textContent = user.name;
        userSelect.appendChild(option);
      });
    }
  }
  
  // æ”¯æ´å†…å®¹ã‚’ä½œæˆ
  function createSupportContent(rowId, supportIndex) {
    // æ”¯æ´å†…å®¹ã®é¸æŠè‚¢
    let typeOptions = '<option value="">é¸æŠ</option>';
    masterSupportTypes.forEach(type => {
      typeOptions += `<option value="${type}">${type}</option>`;
    });
    
    // æ§˜å­ãƒ»çŠ¶æ…‹ã®é¸æŠè‚¢
    let condOptions = '<option value="">é¸æŠ</option>';
    masterConditions.forEach(cond => {
      condOptions += `<option value="${cond}">${cond}</option>`;
    });
    
    const supportDiv = document.createElement('div');
    supportDiv.className = 'support-content-row';
    supportDiv.id = `support-${rowId}-${supportIndex}`;
    
    supportDiv.innerHTML = `
      <div class="input-field">
        <label>
          <span class="support-number">æ”¯æ´${supportIndex}</span>
          æ”¯æ´å†…å®¹ ${supportIndex === 1 ? '<span class="required">*</span>' : ''}
        </label>
        <select class="row-type-${supportIndex}" ${supportIndex === 1 ? 'required' : ''}>
          ${typeOptions}
        </select>
      </div>
      
      <div class="input-field">
        <label>æ”¯æ´æ™‚é–“</label>
        <div class="input-field-time">
          <input type="time" class="row-start-time-${supportIndex}">
          <span>ã€œ</span>
          <input type="time" class="row-end-time-${supportIndex}">
        </div>
      </div>
      
      <div class="input-field">
        <label>æ§˜å­ãƒ»çŠ¶æ…‹</label>
        <select class="row-cond-${supportIndex}">
          ${condOptions}
        </select>
      </div>
      
      <div class="input-field">
        <label>
          æ”¯æ´ã®è©³ç´°
          <button type="button" class="btn-voice" onclick="startVoiceInput(this.closest('.input-field').querySelector('textarea'))" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
        </label>
        <textarea class="row-detail-${supportIndex}" placeholder="å…·ä½“çš„ãªå†…å®¹"></textarea>
      </div>
      
      <div class="input-field">
        <label>
          ç‰¹è¨˜äº‹é …
          <button type="button" class="btn-voice" onclick="startVoiceInput(this.closest('.input-field').querySelector('textarea'))" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
        </label>
        <textarea class="row-note-${supportIndex}" placeholder="ç‰¹è¨˜äº‹é …"></textarea>
      </div>
      
      ${supportIndex > 1 ? `
      <div class="support-actions">
        <button type="button" class="btn btn-remove" onclick="removeSupportContent(${rowId}, ${supportIndex})">âœ• ã“ã®æ”¯æ´å†…å®¹ã‚’å‰Šé™¤</button>
      </div>
      ` : ''}
    `;
    
    return supportDiv;
  }
  
  // æ”¯æ´å†…å®¹ã‚’è¿½åŠ 
  function addSupportContent(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (!row) return;
    
    const supportSection = row.querySelector('.support-content-section');
    if (!supportSection) return;
    
    // ç¾åœ¨ã®æ”¯æ´å†…å®¹æ•°ã‚’å–å¾—
    const currentCount = supportCounterMap[rowId] || 1;
    const newIndex = currentCount + 1;
    
    // æ–°ã—ã„æ”¯æ´å†…å®¹ã‚’ä½œæˆ
    const newSupport = createSupportContent(rowId, newIndex);
    
    // è¿½åŠ ãƒœã‚¿ãƒ³ã®å‰ã«æŒ¿å…¥
    const addButton = supportSection.querySelector('.support-add-button');
    supportSection.insertBefore(newSupport, addButton);
    
    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ›´æ–°
    supportCounterMap[rowId] = newIndex;
    
    // æ–°ã—ã„æ”¯æ´å†…å®¹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    setTimeout(() => {
      newSupport.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
  }
  
  // æ”¯æ´å†…å®¹ã‚’å‰Šé™¤
  function removeSupportContent(rowId, supportIndex) {
    if (!confirm('ã“ã®æ”¯æ´å†…å®¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
    
    const supportDiv = document.getElementById(`support-${rowId}-${supportIndex}`);
    if (supportDiv) {
      supportDiv.remove();
    }
  }
  
  function createInputRow() {
    const rowId = ++rowIdCounter;
    const today = new Date().toISOString().split('T')[0];
    
    // åˆæœŸæ”¯æ´å†…å®¹æ•°ã‚’1ã«è¨­å®š
    supportCounterMap[rowId] = 1;
    
    const row = document.createElement('div');
    row.className = 'input-row';
    row.id = `input-row-${rowId}`;
    
    let serviceOptions = '<option value="">é¸æŠ</option>';
    masterServices.forEach(service => {
      serviceOptions += `<option value="${service}">${service}</option>`;
    });
    
    let staffOptions = '<option value="">é¸æŠ</option>';
    masterStaff.forEach(staff => {
      staffOptions += `<option value="${staff}">${staff}</option>`;
    });
    
    row.innerHTML = `
      <div class="basic-info-row">
        <div class="input-field">
          <label>è¨˜éŒ²æ—¥ <span class="required">*</span></label>
          <input type="date" class="row-date" value="${today}" required>
        </div>
        
        <div class="input-field">
          <label>ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ† <span class="required">*</span></label>
          <select class="row-service" required onchange="updateUserOptions(this, this.value)">
            ${serviceOptions}
          </select>
        </div>
        
        <div class="input-field">
          <label>åˆ©ç”¨è€…å <span class="required">*</span></label>
          <select class="row-user" required>
            <option value="">åˆ©ç”¨è€…ã‚’é¸æŠ</option>
          </select>
        </div>
        
        <div class="input-field">
          <label>è¨˜éŒ²è€…å <span class="required">*</span></label>
          <select class="row-staff" required>
            ${staffOptions}
          </select>
        </div>
      </div>
      
      <div class="support-content-section">
        <div class="support-label">
          <span>ğŸ“ æ”¯æ´å†…å®¹ï¼ˆå¿…è¦ãªã ã‘è¿½åŠ ã§ãã¾ã™ï¼‰</span>
          <button type="button" class="btn btn-add" onclick="addSupportContent(${rowId})">â• æ”¯æ´å†…å®¹è¿½åŠ </button>
        </div>
        <div class="support-add-button"></div>
      </div>
      
      <div class="row-actions">
        <button type="button" class="btn btn-save" onclick="saveRow(${rowId})">âœ“ ä¿å­˜</button>
        <button type="button" class="btn btn-cancel" onclick="removeRow(${rowId})">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    `;
    
    // æœ€åˆã®æ”¯æ´å†…å®¹ã‚’è¿½åŠ 
    const supportSection = row.querySelector('.support-content-section');
    const firstSupport = createSupportContent(rowId, 1);
    const addButton = supportSection.querySelector('.support-add-button');
    supportSection.insertBefore(firstSupport, addButton);
    
    return row;
  }

  function addInputRow() {
    const container = document.getElementById('inputContainer');
    const newRow = createInputRow();
    container.appendChild(newRow);
    newRow.classList.add('active');
    
    setTimeout(() => {
      newRow.scrollIntoView({ behavior: 'smooth', block: 'start' });
      const firstInput = newRow.querySelector('.row-date');
      if (firstInput) firstInput.focus();
    }, 100);
  }

  function removeRow(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (row) {
      row.remove();
      delete supportCounterMap[rowId];
    }
  }

  function saveRow(rowId) {
    const row = document.getElementById(`input-row-${rowId}`);
    if (!row) return;
    
    const date = row.querySelector('.row-date').value;
    const service = row.querySelector('.row-service').value;
    const user = row.querySelector('.row-user').value;
    const staff = row.querySelector('.row-staff').value;
    
    if (!date || !service || !user || !staff) {
      alert('å¿…é ˆé …ç›®ï¼ˆè¨˜éŒ²æ—¥ã€ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ã€åˆ©ç”¨è€…åã€è¨˜éŒ²è€…åï¼‰ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    const type1 = row.querySelector('.row-type-1').value;
    if (!type1) {
      alert('æ”¯æ´å†…å®¹1ã¯å¿…é ˆã§ã™');
      return;
    }
    
    // ã™ã¹ã¦ã®æ”¯æ´å†…å®¹ã‚’åé›†
    const supportContents = [];
    const maxSupport = supportCounterMap[rowId] || 1;
    
    for (let i = 1; i <= maxSupport; i++) {
      const typeEl = row.querySelector(`.row-type-${i}`);
      if (!typeEl) continue; // å‰Šé™¤ã•ã‚ŒãŸæ”¯æ´å†…å®¹ã¯ã‚¹ã‚­ãƒƒãƒ—
      
      const type = typeEl.value;
      if (type) {
        const startTime = row.querySelector(`.row-start-time-${i}`)?.value || '';
        const endTime = row.querySelector(`.row-end-time-${i}`)?.value || '';
        const cond = row.querySelector(`.row-cond-${i}`)?.value || '';
        const detail = row.querySelector(`.row-detail-${i}`)?.value.trim() || '';
        const note = row.querySelector(`.row-note-${i}`)?.value.trim() || '';
        
        let timeRange = '';
        if (startTime && endTime) {
          timeRange = `${startTime}ã€œ${endTime}`;
        } else if (startTime) {
          timeRange = `${startTime}ã€œ`;
        } else if (endTime) {
          timeRange = `ã€œ${endTime}`;
        }
        
        supportContents.push({
          type,
          timeRange,
          cond,
          detail,
          note
        });
      }
    }
    
    if (supportContents.length === 0) {
      alert('å°‘ãªãã¨ã‚‚1ã¤ã®æ”¯æ´å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    const record = { 
      date, 
      service, 
      user, 
      staff,
      supportContents 
    };
    
    records.push(record);
    saveRecords();
    
    filtered = [...records];
    renderTable();
    removeRow(rowId);
    
    alert(`âœ“ è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆæ”¯æ´å†…å®¹: ${supportContents.length}ä»¶ï¼‰`);
  }

  function renderTable() {
    const tbody = document.querySelector('#recordTable tbody');
    tbody.innerHTML = '';
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #999;">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    
    const sorted = [...filtered].sort((a, b) => b.date.localeCompare(a.date));
    
    sorted.forEach(r => {
      const tr = document.createElement('tr');
      
      // æ”¯æ´å†…å®¹ã‚’çµåˆã—ã¦è¡¨ç¤º
      let supportContent = '';
      r.supportContents.forEach((s, idx) => {
        if (idx > 0) supportContent += '<hr style="margin: 8px 0; border: none; border-top: 1px solid #ddd;">';
        supportContent += `
          <div style="margin-bottom: 5px;">
            <strong>ã€${idx + 1}ã€‘${s.type}</strong><br>
            ${s.timeRange ? `â° ${s.timeRange}<br>` : ''}
            ${s.cond ? `ğŸ˜Š ${s.cond}<br>` : ''}
            ${s.detail ? `ğŸ“„ ${s.detail}<br>` : ''}
            ${s.note ? `ğŸ“Œ ${s.note}` : ''}
          </div>
        `;
      });
      
      tr.innerHTML = `
        <td>${r.date}</td>
        <td><span class="service-badge badge-${r.service}">${r.service}</span></td>
        <td>${r.user}</td>
        <td>${r.staff}</td>
        <td style="min-width: 300px;">${supportContent}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function updateFilterOptions() {
    const filterServiceEl = document.getElementById('filterService');
    filterServiceEl.innerHTML = '<option value="">ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†ï¼ˆå…¨ã¦ï¼‰</option>';
    masterServices.forEach(service => {
      const option = document.createElement('option');
      option.value = service;
      option.textContent = service;
      filterServiceEl.appendChild(option);
    });
  }

  function applyFilter() {
    const fMonth = document.getElementById('filterMonth').value;
    const fService = document.getElementById('filterService').value;
    const fUser = document.getElementById('filterUser').value.trim();

    filtered = records.filter(r => {
      let ok = true;
      if (fMonth) ok = ok && r.date.startsWith(fMonth);
      if (fService) ok = ok && r.service === fService;
      if (fUser) ok = ok && r.user.includes(fUser);
      return ok;
    });

    renderTable();
  }

  function resetFilter() {
    filtered = [...records];
    document.getElementById('filterMonth').value = '';
    document.getElementById('filterService').value = '';
    document.getElementById('filterUser').value = '';
    renderTable();
  }

  function exportExcel() {
    if (records.length === 0) {
      alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    const wb = XLSX.utils.book_new();

    const wsData = [
      ['è¨˜éŒ²æ—¥','ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†','åˆ©ç”¨è€…å','è¨˜éŒ²è€…å','æ”¯æ´ç•ªå·','æ”¯æ´å†…å®¹','æ”¯æ´æ™‚é–“','æ§˜å­','è©³ç´°','ç‰¹è¨˜äº‹é …']
    ];
    
    records.forEach(r => {
      r.supportContents.forEach((s, idx) => {
        wsData.push([
          r.date, 
          r.service, 
          r.user, 
          r.staff,
          idx + 1,
          s.type,
          s.timeRange || '',
          s.cond || '',
          s.detail || '',
          s.note || ''
        ]);
      });
    });
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, 'æ—¥åˆ¥è¨˜éŒ²ä¸€è¦§');

    const monthly = {};
    records.forEach(r => {
      const month = r.date.slice(0,7);
      if (!monthly[month]) monthly[month] = 0;
      monthly[month] += r.supportContents.length;
    });
    const monthSheetData = [['æœˆ','ä»¶æ•°'], ...Object.entries(monthly).sort()];
    const wsMonth = XLSX.utils.aoa_to_sheet(monthSheetData);
    XLSX.utils.book_append_sheet(wb, wsMonth, 'æœˆé›†è¨ˆ');

    const serviceCount = {};
    records.forEach(r => {
      if (!serviceCount[r.service]) serviceCount[r.service] = 0;
      serviceCount[r.service] += r.supportContents.length;
    });
    const serviceSheetData = [['ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†','ä»¶æ•°'], ...Object.entries(serviceCount).sort()];
    const wsService = XLSX.utils.aoa_to_sheet(serviceSheetData);
    XLSX.utils.book_append_sheet(wb, wsService, 'ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†åˆ¥é›†è¨ˆ');

    const typeCount = {};
    records.forEach(r => {
      r.supportContents.forEach(s => {
        if (!typeCount[s.type]) typeCount[s.type] = 0;
        typeCount[s.type]++;
      });
    });
    const typeSheetData = [['æ”¯æ´å†…å®¹','ä»¶æ•°'], ...Object.entries(typeCount).sort((a, b) => b[1] - a[1])];
    const wsType = XLSX.utils.aoa_to_sheet(typeSheetData);
    XLSX.utils.book_append_sheet(wb, wsType, 'æ”¯æ´å†…å®¹åˆ¥é›†è¨ˆ');

    const masterData = [
      ['åˆ©ç”¨è€…å', 'ã‚µãƒ¼ãƒ“ã‚¹åŒºåˆ†'],
      ...masterUsers.map(u => [u.name, u.service]),
      [],
      ['è¨˜éŒ²è€…å'],
      ...masterStaff.map(s => [s]),
      [],
      ['æ”¯æ´å†…å®¹'],
      ...masterSupportTypes.map(t => [t]),
      [],
      ['æ§˜å­ãƒ»çŠ¶æ…‹'],
      ...masterConditions.map(c => [c])
    ];
    const wsMaster = XLSX.utils.aoa_to_sheet(masterData);
    XLSX.utils.book_append_sheet(wb, wsMaster, 'ãƒã‚¹ã‚¿ãƒ¼');

    const filename = `æ”¯æ´è¨˜éŒ²_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, filename);
  }

  function clearAll() {
    if (records.length === 0) {
      alert('å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    if (confirm(`ã™ã¹ã¦ã®è¨˜éŒ²ï¼ˆ${records.length}ä»¶ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
      records = [];
      filtered = [];
      saveRecords();
      renderTable();
      alert('ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }
  }

  // åˆæœŸåŒ–
  window.addEventListener('DOMContentLoaded', function() {
    initSpeechRecognition();
    loadMasterData();
    updateFilterOptions();
    renderTable();
    addInputRow();
  });
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  window.onclick = function(event) {
    const masterModal = document.getElementById('masterModal');
    const syncModal = document.getElementById('syncModal');
    if (event.target == masterModal) {
      closeMasterModal();
    }
    if (event.target == syncModal) {
      closeSyncModal();
    }
  }
  
  // iOS Safariã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ”¹å–„
  document.addEventListener('touchstart', function() {}, {passive: true});
</script>

</body>
</html>
